"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _sundog = _interopRequireDefault(require("sundog"));

var _pandaParchment = require("panda-parchment");

var _fairmontMultimethods = require("fairmont-multimethods");

var _kmsKey = require("./kms-key");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var kms;

// Extend Confidential with KMS via sundog.
kms = function (confidential, SDK) {
  var decode, encode, isData, kmsDecrypt, kmsEncrypt, nacl, randomBytes, randomKey;
  ({
    AWS: {
      KMS: {
        randomKey,
        encrypt: kmsEncrypt,
        decrypt: kmsDecrypt
      }
    }
  } = (0, _sundog.default)(SDK));

  confidential.randomBytes = async function (length) {
    return await randomKey(length, "buffer");
  };

  ({
    encode,
    decode,
    isData,
    randomBytes,
    nacl
  } = confidential); // Extension to Symmetric Encryption that encrypts the key with KMS.

  _fairmontMultimethods.Method.define(confidential.encrypt, _kmsKey.isKMSKeyID, isData, async function ({
    id
  }, plaintext) {
    var ciphertext, key, length, lockedKey, nonce, r;
    length = nacl.secretbox.nonceLength + nacl.secretbox.keyLength;
    r = await randomBytes(length);
    key = r.slice(0, nacl.secretbox.keyLength);
    nonce = r.slice(nacl.secretbox.keyLength);
    ciphertext = nacl.secretbox(plaintext, nonce, key);
    lockedKey = await kmsEncrypt(id, key, "buffer");
    return encode({
      lockedKey: lockedKey,
      // Already base64
      ciphertext: encode("base64", ciphertext),
      nonce: encode("base64", nonce)
    });
  });

  _fairmontMultimethods.Method.define(confidential.encrypt, _kmsKey.isKMSKeyID, _pandaParchment.isString, _pandaParchment.isString, function (key, plaintext, encoding) {
    return confidential.encrypt(key, decode(encoding, plaintext));
  });

  _fairmontMultimethods.Method.define(confidential.encrypt, _kmsKey.isKMSKeyID, _pandaParchment.isString, function (key, plaintext) {
    return confidential.encrypt(key, decode("utf8", plaintext));
  }); // Extension to Symmetric Decryption that encrypts the key with KMS.


  _fairmontMultimethods.Method.define(confidential.decrypt, _kmsKey.isKMSKeyID, isData, _pandaParchment.isString, async function ({
    id
  }, blob, encoding) {
    var ciphertext, key, lockedKey, nonce;
    ({
      ciphertext,
      nonce,
      lockedKey
    } = JSON.parse(encode("utf8", blob)));
    ciphertext = decode("base64", ciphertext);
    nonce = decode("base64", nonce);
    key = await kmsDecrypt(lockedKey, "buffer");
    return encode(encoding, nacl.secretbox.open(ciphertext, nonce, key));
  });

  _fairmontMultimethods.Method.define(confidential.decrypt, _kmsKey.isKMSKeyID, isData, function (key, blob) {
    return confidential.decrypt(key, blob, "utf8");
  });

  _fairmontMultimethods.Method.define(confidential.decrypt, _kmsKey.isKMSKeyID, _pandaParchment.isString, _pandaParchment.isString, function (key, blob, encoding) {
    return confidential.decrypt(key, decode("base64", blob), encoding);
  });

  _fairmontMultimethods.Method.define(confidential.decrypt, _kmsKey.isKMSKeyID, _pandaParchment.isString, function (key, blob) {
    return confidential.decrypt(key, decode("base64", blob), "utf8");
  });

  return confidential;
};

var _default = kms;
exports.default = _default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZC9SZXBvc2l0b3JpZXMvcGFuZGEtY29uZmlkZW50aWFsL3Rlc3QvdGVzdHMvZXh0ZW5kZWQva21zLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFIQSxJQUFBLEdBQUE7OztBQU1BLEdBQUEsR0FBTSxVQUFBLFlBQUEsRUFBQSxHQUFBLEVBQUE7QUFDSixNQUFBLE1BQUEsRUFBQSxNQUFBLEVBQUEsTUFBQSxFQUFBLFVBQUEsRUFBQSxVQUFBLEVBQUEsSUFBQSxFQUFBLFdBQUEsRUFBQSxTQUFBO0FBQUEsR0FBQTtBQUFDLElBQUEsR0FBQSxFQUFJO0FBQUEsTUFBQSxHQUFBLEVBQUk7QUFBQSxRQUFBLFNBQUE7QUFBWSxRQUFBLE9BQUEsRUFBWixVQUFBO0FBQWdDLFFBQUEsT0FBQSxFQUFRO0FBQXhDO0FBQUo7QUFBTCxNQUFnRSxxQkFBaEUsR0FBZ0UsQ0FBaEU7O0FBRUEsRUFBQSxZQUFZLENBQVosV0FBQSxHQUEyQixnQkFBQSxNQUFBLEVBQUE7QUFBWSxXQUFBLE1BQU0sU0FBQSxDQUFBLE1BQUEsRUFBTixRQUFNLENBQU47QUFBWixHQUEzQjs7QUFDQSxHQUFBO0FBQUEsSUFBQSxNQUFBO0FBQUEsSUFBQSxNQUFBO0FBQUEsSUFBQSxNQUFBO0FBQUEsSUFBQSxXQUFBO0FBQUEsSUFBQTtBQUFBLE1BSEEsWUFHQSxFQUpJLEM7O0FBT0osK0JBQUEsTUFBQSxDQUFjLFlBQVksQ0FBMUIsT0FBQSxFQUFBLGtCQUFBLEVBQUEsTUFBQSxFQUNFLGdCQUFDO0FBQUQsSUFBQTtBQUFDLEdBQUQsRUFBQSxTQUFBLEVBQUE7QUFDRSxRQUFBLFVBQUEsRUFBQSxHQUFBLEVBQUEsTUFBQSxFQUFBLFNBQUEsRUFBQSxLQUFBLEVBQUEsQ0FBQTtBQUFBLElBQUEsTUFBQSxHQUFTLElBQUksQ0FBQyxTQUFMLENBQUEsV0FBQSxHQUE2QixJQUFJLENBQUMsU0FBTCxDQUFl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LENBQTFCLE9BQUEsRUFBQSxrQkFBQSxFQUFBLHdCQUFBLEVBQ0UsVUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBO1dBQ0UsWUFBWSxDQUFaLE9BQUEsQ0FBQSxHQUFBLEVBQTBCLE1BQUEsQ0FBQSxRQUFBLEVBQTFCLElBQTBCLENBQTFCLEVBQUEsTUFBQSxDO0FBRkosR0FBQTs7U0FJQSxZO0FBOUNJLENBQU47O2VBZ0RlLEciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3VuZG9nIGZyb20gXCJzdW5kb2dcIlxuaW1wb3J0IHtpc1N0cmluZ30gZnJvbSBcInBhbmRhLXBhcmNobWVudFwiXG5pbXBvcnQge01ldGhvZH0gZnJvbSBcImZhaXJtb250LW11bHRpbWV0aG9kc1wiXG5pbXBvcnQge2lzS01TS2V5SUR9IGZyb20gXCIuL2ttcy1rZXlcIlxuXG4jIEV4dGVuZCBDb25maWRlbnRpYWwgd2l0aCBLTVMgdmlhIHN1bmRvZy5cbmttcyA9IChjb25maWRlbnRpYWwsIFNESykgLT5cbiAge0FXUzpLTVM6e3JhbmRvbUtleSwgZW5jcnlwdDprbXNFbmNyeXB0LCBkZWNyeXB0Omttc0RlY3J5cHR9fSA9IFN1bmRvZyBTREtcblxuICBjb25maWRlbnRpYWwucmFuZG9tQnl0ZXMgPSAobGVuZ3RoKSAtPiBhd2FpdCByYW5kb21LZXkgbGVuZ3RoLCBcImJ1ZmZlclwiXG4gIHtlbmNvZGUsIGRlY29kZSwgaXNEYXRhLCByYW5kb21CeXRlcywgbmFjbH0gPSBjb25maWRlbnRpYWxcblxuICAjIEV4dGVuc2lvbiB0byBTeW1tZXRyaWMgRW5jcnlwdGlvbiB0aGF0IGVuY3J5cHRzIHRoZSBrZXkgd2l0aCBLTVMuXG4gIE1ldGhvZC5kZWZpbmUgY29uZmlkZW50aWFsLmVuY3J5cHQsIGlzS01TS2V5SUQsIGlzRGF0YSxcbiAgICAoe2lkfSwgcGxhaW50ZXh0KSAtPlxuICAgICAgbGVuZ3RoID0gbmFjbC5zZWNyZXRib3gubm9uY2VMZW5ndGggKyBuYWNsLnNlY3JldGJveC5rZXlMZW5ndGhcbiAgICAgIHIgPSBhd2FpdCByYW5kb21CeXRlcyBsZW5ndGhcbiAgICAgIGtleSA9IHIuc2xpY2UgMCwgbmFjbC5zZWNyZXRib3gua2V5TGVuZ3RoXG4gICAgICBub25jZSA9IHIuc2xpY2UgbmFjbC5zZWNyZXRib3gua2V5TGVuZ3RoXG5cbiAgICAgIGNpcGhlcnRleHQgPSBuYWNsLnNlY3JldGJveCBwbGFpbnRleHQsIG5vbmNlLCBrZXlcbiAgICAgIGxvY2tlZEtleSA9IGF3YWl0IGttc0VuY3J5cHQgaWQsIGtleSwgXCJidWZmZXJcIlxuICAgICAgZW5jb2RlXG4gICAgICAgIGxvY2tlZEtleTogbG9ja2VkS2V5ICMgQWxyZWFkeSBiYXNlNjRcbiAgICAgICAgY2lwaGVydGV4dDogZW5jb2RlIFwiYmFzZTY0XCIsIGNpcGhlcnRleHRcbiAgICAgICAgbm9uY2U6IGVuY29kZSBcImJhc2U2NFwiLCBub25jZVxuXG4gIE1ldGhvZC5kZWZpbmUgY29uZmlkZW50aWFsLmVuY3J5cHQsIGlzS01TS2V5SUQsIGlzU3RyaW5nLCBpc1N0cmluZyxcbiAgICAoa2V5LCBwbGFpbnRleHQsIGVuY29kaW5nKSAtPlxuICAgICAgY29uZmlkZW50aWFsLmVuY3J5cHQga2V5LCBkZWNvZGUoZW5jb2RpbmcsIHBsYWludGV4dClcbiAgTWV0aG9kLmRlZmluZSBjb25maWRlbnRpYWwuZW5jcnlwdCwgaXNLTVNLZXlJRCwgaXNTdHJpbmcsXG4gICAgKGtleSwgcGxhaW50ZXh0KSAtPlxuICAgICAgY29uZmlkZW50aWFsLmVuY3J5cHQga2V5LCBkZWNvZGUoXCJ1dGY4XCIsIHBsYWludGV4dClcblxuICAjIEV4dGVuc2lvbiB0byBTeW1tZXRyaWMgRGVjcnlwdGlvbiB0aGF0IGVuY3J5cHRzIHRoZSBrZXkgd2l0aCBLTVMuXG4gIE1ldGhvZC5kZWZpbmUgY29uZmlkZW50aWFsLmRlY3J5cHQsIGlzS01TS2V5SUQsIGlzRGF0YSwgaXNTdHJpbmcsXG4gICAgKHtpZH0sIGJsb2IsIGVuY29kaW5nKSAtPlxuICAgICAge2NpcGhlcnRleHQsIG5vbmNlLCBsb2NrZWRLZXl9ID0gSlNPTi5wYXJzZSBlbmNvZGUgXCJ1dGY4XCIsIGJsb2JcbiAgICAgIGNpcGhlcnRleHQgPSBkZWNvZGUgXCJiYXNlNjRcIiwgY2lwaGVydGV4dFxuICAgICAgbm9uY2UgPSBkZWNvZGUgXCJiYXNlNjRcIiwgbm9uY2VcbiAgICAgIGtleSA9IGF3YWl0IGttc0RlY3J5cHQgbG9ja2VkS2V5LCBcImJ1ZmZlclwiXG4gICAgICBlbmNvZGUgZW5jb2RpbmcsIG5hY2wuc2VjcmV0Ym94Lm9wZW4gY2lwaGVydGV4dCwgbm9uY2UsIGtleVxuICBNZXRob2QuZGVmaW5lIGNvbmZpZGVudGlhbC5kZWNyeXB0LCBpc0tNU0tleUlELCBpc0RhdGEsXG4gICAgKGtleSwgYmxvYikgLT5cbiAgICAgIGNvbmZpZGVudGlhbC5kZWNyeXB0IGtleSwgYmxvYiwgXCJ1dGY4XCJcbiAgTWV0aG9kLmRlZmluZSBjb25maWRlbnRpYWwuZGVjcnlwdCwgaXNLTVNLZXlJRCwgaXNTdHJpbmcsIGlzU3RyaW5nLFxuICAgIChrZXksIGJsb2IsIGVuY29kaW5nKSAtPlxuICAgICAgY29uZmlkZW50aWFsLmRlY3J5cHQga2V5LCBkZWNvZGUoXCJiYXNlNjRcIiwgYmxvYiksIGVuY29kaW5nXG4gIE1ldGhvZC5kZWZpbmUgY29uZmlkZW50aWFsLmRlY3J5cHQsIGlzS01TS2V5SUQsIGlzU3RyaW5nLFxuICAgIChrZXksIGJsb2IpIC0+XG4gICAgICBjb25maWRlbnRpYWwuZGVjcnlwdCBrZXksIGRlY29kZShcImJhc2U2NFwiLCBibG9iKSwgXCJ1dGY4XCJcblxuICBjb25maWRlbnRpYWxcblxuZXhwb3J0IGRlZmF1bHQga21zXG4iXSwic291cmNlUm9vdCI6IiJ9
//# sourceURL=/Users/david/Repositories/panda-confidential/test/tests/extended/kms.coffee